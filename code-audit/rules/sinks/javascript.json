{
  "language": "JavaScript",
  "description": "JavaScript/Node.js 危险函数 (Sink点)",

  "sinks": [
    {
      "name": "eval_function",
      "pattern": "eval\\(",
      "vuln_types": ["rce", "code_injection"],
      "description": "eval() - 执行JavaScript代码",
      "dangerous_param": 0,
      "examples": [
        "eval(userInput)",
        "eval('console.log(' + data + ')')"
      ],
      "cwe": ["CWE-94", "CWE-95"],
      "remediation": "避免使用eval，使用JSON.parse()解析JSON"
    },
    {
      "name": "function_constructor",
      "pattern": "new Function\\(",
      "vuln_types": ["rce", "code_injection"],
      "description": "Function构造器 - 动态创建函数",
      "dangerous_param": [0, 1],
      "examples": [
        "new Function(userInput)",
        "new Function('return ' + data)"
      ],
      "cwe": ["CWE-94", "CWE-95"],
      "remediation": "避免使用Function构造器"
    },
    {
      "name": "settimeout_string",
      "pattern": "setTimeout\\(['\"]",
      "vuln_types": ["rce", "code_injection"],
      "description": "setTimeout字符串形式 - 执行代码",
      "dangerous_param": 0,
      "examples": [
        "setTimeout(userInput, 1000)",
        "setTimeout('alert(' + data + ')', 1000)"
      ],
      "cwe": ["CWE-94"],
      "remediation": "使用函数形式而非字符串"
    },
    {
      "name": "setinterval_string",
      "pattern": "setInterval\\(['\"]",
      "vuln_types": ["rce", "code_injection"],
      "description": "setInterval字符串形式 - 执行代码",
      "dangerous_param": 0,
      "examples": [
        "setInterval(userInput, 1000)"
      ],
      "cwe": ["CWE-94"],
      "remediation": "使用函数形式而非字符串"
    },
    {
      "name": "child_process_exec",
      "pattern": "(?:exec|execSync|spawn|spawnSync|fork)\\(",
      "vuln_types": ["command_injection", "rce"],
      "description": "child_process.exec - 执行系统命令",
      "dangerous_param": 0,
      "modules": ["child_process"],
      "examples": [
        "require('child_process').exec(userInput)",
        "exec('ls ' + dirname)",
        "spawn('sh', ['-c', command])"
      ],
      "cwe": ["CWE-78", "CWE-77"],
      "remediation": "使用参数化形式，避免shell解释"
    },
    {
      "name": "vm_runInThisContext",
      "pattern": "vm\\.runInThisContext\\(",
      "vuln_types": ["rce", "code_injection"],
      "description": "vm.runInThisContext - 在当前上下文执行代码",
      "dangerous_param": 0,
      "modules": ["vm"],
      "examples": [
        "vm.runInThisContext(userInput)"
      ],
      "cwe": ["CWE-94"],
      "remediation": "避免执行不可信代码"
    },
    {
      "name": "vm_runInNewContext",
      "pattern": "vm\\.runInNewContext\\(",
      "vuln_types": ["rce", "code_injection"],
      "description": "vm.runInNewContext - 在新上下文执行代码",
      "dangerous_param": 0,
      "modules": ["vm"],
      "examples": [
        "vm.runInNewContext(userInput)"
      ],
      "cwe": ["CWE-94"],
      "remediation": "避免执行不可信代码"
    },
    {
      "name": "vm_runInContext",
      "pattern": "vm\\.runInContext\\(",
      "vuln_types": ["rce", "code_injection"],
      "description": "vm.runInContext - 在指定上下文执行代码",
      "dangerous_param": 0,
      "modules": ["vm"],
      "examples": [
        "vm.runInContext(userInput)"
      ],
      "cwe": ["CWE-94"],
      "remediation": "避免执行不可信代码"
    },
    {
      "name": "vm_script_run",
      "pattern": "new vm\\.Script\\(",
      "vuln_types": ["rce", "code_injection"],
      "description": "new vm.Script() - 创建可执行脚本",
      "dangerous_param": 0,
      "modules": ["vm"],
      "examples": [
        "new vm.Script(userInput)"
      ],
      "cwe": ["CWE-94"],
      "remediation": "避免执行不可信代码"
    },
    {
      "name": "mysql_query",
      "pattern": "(?:query|execute)\\(",
      "vuln_types": ["sqli"],
      "description": "MySQL查询执行 - SQL注入",
      "dangerous_param": 0,
      "modules": ["mysql", "mysql2"],
      "examples": [
        "connection.query('SELECT * FROM users WHERE id = ' + id)",
        "db.execute('UPDATE users SET name = \'' + name + '\'')"
      ],
      "cwe": ["CWE-89"],
      "remediation": "使用参数化查询或prepared statements"
    },
    {
      "name": "pg_query",
      "pattern": "(?:query)\\(",
      "vuln_types": ["sqli"],
      "description": "PostgreSQL查询执行 - SQL注入",
      "dangerous_param": 0,
      "modules": ["pg"],
      "examples": [
        "client.query('SELECT * FROM users WHERE id = ' + id)"
      ],
      "cwe": ["CWE-89"],
      "remediation": "使用参数化查询 $1, $2 等"
    },
    {
      "name": "sequelize_query",
      "pattern": "(?:query|findAll|findOne|findAndCountAll)\\(",
      "vuln_types": ["sqli"],
      "description": "Sequelize ORM - 原始SQL查询",
      "dangerous_param": 0,
      "modules": ["sequelize"],
      "examples": [
        "sequelize.query('SELECT * FROM users WHERE id = ' + id)"
      ],
      "cwe": ["CWE-89"],
      "remediation": "使用Sequelize查询构建器，避免拼接SQL"
    },
    {
      "name": "mongoose_find",
      "pattern": "(?:find|findOne|where)\\(",
      "vuln_types": ["nosql_injection"],
      "description": "Mongoose查询 - NoSQL注入",
      "dangerous_param": 0,
      "modules": ["mongoose"],
      "examples": [
        "User.find(JSON.parse(query))",
        "User.where({ name: req.query.name })"
      ],
      "cwe": ["CWE-943"],
      "remediation": "使用类型转换和严格模式"
    },
    {
      "name": "fs_readFile",
      "pattern": "fs\\.readFile\\(",
      "vuln_types": ["path_traversal", "file_disclosure"],
      "description": "fs.readFile - 读取文件",
      "dangerous_param": 0,
      "modules": ["fs"],
      "examples": [
        "fs.readFile('/path/' + filename)",
        "fs.readFileSync(userPath)"
      ],
      "cwe": ["CWE-22", "CWE-23"],
      "remediation": "验证并规范化文件路径，使用path.basename()"
    },
    {
      "name": "fs_readFileSync",
      "pattern": "fs\\.readFileSync\\(",
      "vuln_types": ["path_traversal", "file_disclosure"],
      "description": "fs.readFileSync - 同步读取文件",
      "dangerous_param": 0,
      "modules": ["fs"],
      "examples": [
        "fs.readFileSync('/path/' + filename)"
      ],
      "cwe": ["CWE-22"],
      "remediation": "验证并规范化文件路径"
    },
    {
      "name": "fs_writeFile",
      "pattern": "fs\\.writeFile\\(",
      "vuln_types": ["path_traversal", "arbitrary_file_write"],
      "description": "fs.writeFile - 写入文件",
      "dangerous_param": 0,
      "modules": ["fs"],
      "examples": [
        "fs.writeFile('/path/' + filename, content)"
      ],
      "cwe": ["CWE-22"],
      "remediation": "验证并规范化文件路径"
    },
    {
      "name": "fs_unlink",
      "pattern": "fs\\.unlink\\(",
      "vuln_types": ["path_traversal", "file_deletion"],
      "description": "fs.unlink - 删除文件",
      "dangerous_param": 0,
      "modules": ["fs"],
      "examples": [
        "fs.unlink('/path/' + filename)"
      ],
      "cwe": ["CWE-22"],
      "remediation": "验证并规范化文件路径"
    },
    {
      "name": "http_get_request",
      "pattern": "(?:http\\.get|https\\.get|axios\\.get|fetch|got)\\(",
      "vuln_types": ["ssrf", "url_redirection"],
      "description": "HTTP请求 - SSRF",
      "dangerous_param": 0,
      "modules": ["http", "https", "axios", "fetch", "got", "node-fetch"],
      "examples": [
        "http.get(userUrl)",
        "axios.get(url)",
        "fetch(targetUrl)"
      ],
      "cwe": ["CWE-918"],
      "remediation": "验证URL，使用白名单或URL解析"
    },
    {
      "name": "http_post_request",
      "pattern": "(?:http\\.post|https\\.post|axios\\.post)\\(",
      "vuln_types": ["ssrf", "url_redirection"],
      "description": "HTTP POST请求 - SSRF",
      "dangerous_param": 1,
      "modules": ["http", "https", "axios"],
      "examples": [
        "axios.post(userUrl, data)"
      ],
      "cwe": ["CWE-918"],
      "remediation": "验证URL，使用白名单"
    },
    {
      "name": "res_send",
      "pattern": "res\\.send\\(",
      "vuln_types": ["xss", "reflected_xss"],
      "description": "res.send() - 响应数据（潜在XSS）",
      "dangerous_param": 0,
      "frameworks": ["express"],
      "examples": [
        "res.send(userInput)",
        "res.send('<div>' + name + '</div>')"
      ],
      "cwe": ["CWE-79"],
      "remediation": "对输出进行HTML编码"
    },
    {
      "name": "res_json",
      "pattern": "res\\.json\\(",
      "vuln_types": ["xss"],
      "description": "res.json() - JSON响应",
      "dangerous_param": 0,
      "frameworks": ["express"],
      "examples": [
        "res.json({ data: userInput })"
      ],
      "cwe": ["CWE-79"],
      "remediation": "JSON响应相对安全，但需检查客户端处理"
    },
    {
      "name": "res_render",
      "pattern": "res\\.render\\(",
      "vuln_types": ["xss", "ssti"],
      "description": "res.render() - 渲染模板",
      "dangerous_param": [0, 1],
      "frameworks": ["express"],
      "examples": [
        "res.render('view', { name: userInput })",
        "res.render(templateName)"
      ],
      "cwe": ["CWE-79", "CWE-94"],
      "remediation": "使用模板引擎的自动转义功能"
    },
    {
      "name": "innerHTML",
      "pattern": "\\.innerHTML\\s*=",
      "vuln_types": ["dom_xss"],
      "description": "innerHTML - 设置HTML内容（DOM XSS）",
      "dangerous_param": null,
      "examples": [
        "element.innerHTML = userInput",
        "document.body.innerHTML = data"
      ],
      "cwe": ["CWE-79"],
      "remediation": "使用textContent或innerText，或对输入编码"
    },
    {
      "name": "outerHTML",
      "pattern": "\\.outerHTML\\s*=",
      "vuln_types": ["dom_xss"],
      "description": "outerHTML - 替换元素（DOM XSS）",
      "dangerous_param": null,
      "examples": [
        "element.outerHTML = userInput"
      ],
      "cwe": ["CWE-79"],
      "remediation": "使用textContent或对输入编码"
    },
    {
      "name": "document_write",
      "pattern": "document\\.(?:write|writeln)\\(",
      "vuln_types": ["dom_xss"],
      "description": "document.write() - 写入HTML",
      "dangerous_param": 0,
      "examples": [
        "document.write(userInput)",
        "document.writeln('<img src=' + url + '>')"
      ],
      "cwe": ["CWE-79"],
      "remediation": "避免使用document.write，使用DOM方法"
    },
    {
      "name": "jquery_html",
      "pattern": "\\.html\\(",
      "vuln_types": ["dom_xss"],
      "description": "$.html() - jQuery设置HTML",
      "dangerous_param": 0,
      "modules": ["jquery"],
      "examples": [
        "$('#element').html(userInput)",
        "$('.content').html(data)"
      ],
      "cwe": ["CWE-79"],
      "remediation": "使用.text()方法或对输入编码"
    },
    {
      "name": "dom_eval",
      "pattern": "\\$\\.(?:globalEval|parseHTML)\\(",
      "vuln_types": ["dom_xss", "code_injection"],
      "description": "jQuery执行代码",
      "dangerous_param": 0,
      "modules": ["jquery"],
      "examples": [
        "$.globalEval(userInput)",
        "$.parseHTML('<img src=x onerror=alert(1)>')"
      ],
      "cwe": ["CWE-79"],
      "remediation": "避免执行不可信HTML/JavaScript"
    },
    {
      "name": "redirect",
      "pattern": "res\\.(?:redirect|location)\\(",
      "vuln_types": ["open_redirect"],
      "description": "HTTP重定向 - 开放重定向",
      "dangerous_param": 0,
      "frameworks": ["express"],
      "examples": [
        "res.redirect(userUrl)",
        "res.location(nextUrl)"
      ],
      "cwe": ["CWE-601"],
      "remediation": "验证URL，使用白名单或相对URL"
    },
    {
      "name": "ejs_render",
      "pattern": "ejs\\.render\\(",
      "vuln_types": ["ssti"],
      "description": "EJS模板渲染 - 服务端模板注入",
      "dangerous_param": 1,
      "modules": ["ejs"],
      "examples": [
        "ejs.render(template, { name: userInput })",
        "ejs.render(templateName)"
      ],
      "cwe": ["CWE-94"],
      "remediation": "避免渲染用户控制的模板名"
    },
    {
      "name": "pug_render",
      "pattern": "pug\\.render\\(",
      "vuln_types": ["ssti"],
      "description": "Pug模板渲染 - 服务端模板注入",
      "dangerous_param": 1,
      "modules": ["pug"],
      "examples": [
        "pug.render(template, { data: userInput })"
      ],
      "cwe": ["CWE-94"],
      "remediation": "使用固定模板，避免动态模板名"
    },
    {
      "name": "handlebars_compile",
      "pattern": "Handlebars\\.compile\\(",
      "vuln_types": ["ssti"],
      "description": "Handlebars编译模板",
      "dangerous_param": 0,
      "modules": ["handlebars"],
      "examples": [
        "Handlebars.compile(userInput)"
      ],
      "cwe": ["CWE-94"],
      "remediation": "避免编译用户控制的模板"
    },
    {
      "name": "json_parse",
      "pattern": "JSON\\.parse\\(",
      "vuln_types": ["prototype_pollution"],
      "description": "JSON.parse - 原型链污染",
      "dangerous_param": 0,
      "examples": [
        "JSON.parse(userInput)",
        'JSON.parse(\'{"__proto__": {"admin": true}}\')'
      ],
      "cwe": ["CWE-1321"],
      "remediation": "使用JSON验证schema或ProtoPollution防御"
    },
    {
      "name": "object_assign",
      "pattern": "Object\\.assign\\(",
      "vuln_types": ["prototype_pollution"],
      "description": "Object.assign - 原型链污染",
      "dangerous_param": [0, 1],
      "examples": [
        "Object.assign(target, userInput)",
        "Object.assign({}, JSON.parse(data))"
      ],
      "cwe": ["CWE-1321"],
      "remediation": "冻结Object.prototype或验证输入"
    },
    {
      "name": "merge",
      "pattern": "(?:lodash|underscore)\\.merge\\(",
      "vuln_types": ["prototype_pollution"],
      "description": "merge函数 - 原型链污染",
      "dangerous_param": [0, 1],
      "modules": ["lodash", "underscore"],
      "examples": [
        "_.merge(target, userInput)",
        "_.merge({}, req.body)"
      ],
      "cwe": ["CWE-1321"],
      "remediation": "使用lodash 4.17.21+或使用替代函数"
    },
    {
      "name": "yaml_load",
      "pattern": "yaml\\.load\\(",
      "vuln_types": ["deserialization", "rce"],
      "description": "YAML加载 - 反序列化RCE",
      "dangerous_param": 0,
      "modules": ["js-yaml"],
      "examples": [
        "yaml.load(userInput)",
        "yaml.parse(yamlString)"
      ],
      "cwe": ["CWE-502"],
      "remediation": "使用yaml.safeLoad()而非yaml.load()"
    },
    {
      "name": "node_vm2",
      "pattern": "new VM\\(",
      "vuln_types": ["sandbox_escape", "rce"],
      "description": "VM2沙箱执行 - 沙箱逃逸",
      "dangerous_param": 0,
      "modules": ["vm2"],
      "examples": [
        "new VM({ timeout: 1000 }).run(userInput)"
      ],
      "cwe": ["CWE-265"],
      "remediation": "vm2已废弃且存在漏洞，使用vm3或isolated-vm"
    },
    {
      "name": "redis_eval",
      "pattern": "redis\\.eval\\(",
      "vuln_types": ["rce"],
      "description": "Redis EVAL - Lua代码执行",
      "dangerous_param": 0,
      "modules": ["redis"],
      "examples": [
        "redis.eval(userScript)"
      ],
      "cwe": ["CWE-94"],
      "remediation": "避免执行用户控制的Lua脚本"
    },
    {
      "name": "mongodb_eval",
      "pattern": "db\\.eval\\(",
      "vuln_types": ["nosql_injection", "rce"],
      "description": "MongoDB eval - JavaScript执行",
      "dangerous_param": 0,
      "modules": ["mongodb"],
      "examples": [
        "db.eval(userFunction)"
      ],
      "cwe": ["CWE-94"],
      "remediation": "避免使用db.eval，已废弃"
    }
  ]
}
