# 权限与漏洞评估指南

## 核心原则

**任何可达的 Source → Sink 数据流都是漏洞，无论需要什么权限。**

权限等级只影响：
1. **风险评级** (Critical/High/Medium/Low)
2. **利用难度** (易/中/难)
3. **修复优先级** (P0/P1/P2)

权限等级**不影响**：
- 是否报告该漏洞
- 是否生成 PoC
- 是否包含在报告中

---

## 常见误区

### ❌ 误区 1: "需要登录就不是漏洞"

**错误思维：**
```
"这个 SQL 注入需要登录才能访问，所以风险不高，不用报告。"
```

**正确思维：**
```
✅ 这是一个 SQL 注入漏洞
✅ 任何已登录用户都可以利用它读取/修改整个数据库
✅ 风险评级：HIGH (不是 Critical，因为需要认证)
✅ 必须报告并修复
```

**实际案例：**
```java
// blade-tool 中的 DatasourceServletAction
@RequiredLogin  // 需要登录
@RequestMapping("/datasource")
public class DatasourceServletAction {
    
    public void previewData(HttpServletRequest req) {
        String sql = req.getParameter("sql");  // 用户输入
        jdbc.queryForList(sql, map);           // 直接执行！
    }
}
```

**评估：**
- 需要权限：✅ 已登录用户（任何角色）
- 是否是漏洞：✅ **是**
- 风险等级：🔴 **HIGH** (CVSS 8.1)
  - 不是 Critical 因为需要认证
  - 但仍然是 High 因为影响整个数据库
- 优先级：**P1** (1周内修复)

### ❌ 误区 2: "管理员功能不需要审计"

**错误思维：**
```
"这是管理员后台的功能，只有管理员能访问，不需要关注安全问题。"
```

**正确思维：**
```
✅ 管理员账号可能被：
   - 钓鱼攻击获取
   - 暴力破解（如果密码弱）
   - 内部人员滥用
✅ 管理员功能的漏洞仍然需要报告
✅ 风险评级会相应调整，但不能忽略
```

**实际案例：**
```java
@PreAuthorize("hasRole('ADMIN')")  // 仅管理员
@PostMapping("/system/execute")
public void executeCommand(String cmd) {
    Runtime.getRuntime().exec(cmd);  // 命令注入！
}
```

**评估：**
- 需要权限：✅ 管理员
- 是否是漏洞：✅ **是**
- 风险等级：🟠 **MEDIUM** (CVSS 6.5)
  - 降级因为需要高权限
  - 但命令注入本身是严重问题
- 优先级：**P2** (2-4周内修复)
- 修复建议：
  1. 使用白名单限制可执行的命令
  2. 或者移除此功能，使用更安全的替代方案

### ❌ 误区 3: "已经有 WAF，不用担心注入"

**错误思维：**
```
"我们有 WAF，会自动过滤恶意输入，所以 SQL 注入不是问题。"
```

**正确思维：**
```
✅ WAF 可以被绕过（编码、大小写、注释等）
✅ WAF 是防御层，不是修复
✅ 源代码中的漏洞仍然需要修复
✅ 深度防御原则：WAF + 代码修复
```

---

## 权限等级分类

### Level 0: PUBLIC (无需认证)

**定义：**
- 任何人都可以访问
- 不需要登录
- 不需要 token/cookie

**示例：**
```java
@GetMapping("/api/public/search")
public List<User> search(@RequestParam String keyword) {
    return userService.search(keyword);  // 可能有注入
}
```

**风险评级调整：**
- 漏洞类型 = Critical → **Critical**
- 漏洞类型 = High → **Critical** ⬆️
- 漏洞类型 = Medium → **High** ⬆️

### Level 1: AUTHENTICATED (需要登录)

**定义：**
- 需要登录/认证
- 但无角色限制
- 任何已登录用户都可访问

**示例：**
```java
@RequiredLogin
@PostMapping("/api/report/preview")
public void preview(@RequestParam String sql) {
    jdbc.execute(sql);  // SQL 注入
}
```

**风险评级调整：**
- 漏洞类型 = Critical → **High** ⬇️
- 漏洞类型 = High → **High**
- 漏洞类型 = Medium → **Medium**

### Level 2: PRIVILEGED (特权用户)

**定义：**
- 需要特定角色（如 ADMIN, MANAGER）
- 有权限验证
- 仅少数用户可访问

**示例：**
```java
@PreAuthorize("hasRole('ADMIN')")
@PostMapping("/api/admin/config")
public void updateConfig(@RequestBody Config config) {
    // 可能有反序列化漏洞
    ObjectInputStream.readObject(config);
}
```

**风险评级调整：**
- 漏洞类型 = Critical → **Medium** ⬇️⬇️
- 漏洞类型 = High → **Medium** ⬇️
- 漏洞类型 = Medium → **Low** ⬇️

---

## 风险评级矩阵

| 漏洞类型 | PUBLIC | AUTHENTICATED | PRIVILEGED |
|---------|--------|---------------|------------|
| SQL Injection (High) | 🔴 Critical | 🔴 High | 🟠 Medium |
| XSS (Medium) | 🔴 High | 🟠 Medium | 🟢 Low |
| Command Injection (Critical) | 🔴 Critical | 🔴 High | 🟠 Medium |
| IDOR (Medium) | 🔴 High | 🟠 Medium | 🟢 Low |
| File Upload RCE (Critical) | 🔴 Critical | 🔴 High | 🟠 Medium |
| Path Traversal (Medium) | 🔴 High | 🟠 Medium | 🟢 Low |
| XXE (High) | 🔴 Critical | 🔴 High | 🟠 Medium |
| Deserialization (Critical) | 🔴 Critical | 🔴 High | 🟠 Medium |

---

## CVSS 评分调整

### 基础分数计算

```
CVSS 3.1 Base Score 包括：
- Attack Vector (AV): 网络/相邻/本地/物理
- Attack Complexity (AC): 低/高
- Privileges Required (PR): 无/低/高 ← 这里体现权限
- User Interaction (UI): 无/需要
- Scope (S): 不变/改变
- Confidentiality (C): 无/低/高
- Integrity (I): 无/低/高
- Availability (A): 无/低/高
```

### 权限对 PR 的影响

| 权限等级 | CVSS PR | 分数影响 |
|---------|---------|---------|
| PUBLIC | None | 0.85 (最高) |
| AUTHENTICATED | Low | 0.62 |
| PRIVILEGED | High | 0.27 (最低) |

**示例计算：**

```
漏洞：SQL Injection in /api/datasource/preview

场景 1: PUBLIC (无需认证)
- AV:N, AC:L, PR:N, UI:N, S:C, C:H, I:H, A:H
- CVSS Base Score: 10.0 (Critical)

场景 2: AUTHENTICATED (需登录)
- AV:N, AC:L, PR:L, UI:N, S:C, C:H, I:H, A:H
- CVSS Base Score: 9.1 (Critical)

场景 3: PRIVILEGED (仅管理员)
- AV:N, AC:L, PR:H, UI:N, S:C, C:H, I:H, A:H
- CVSS Base Score: 7.2 (High)
```

---

## 报告示例

### 示例 1: 已认证的 SQL 注入

```markdown
## VULN-003: SQL Injection in Report Data Preview

### 漏洞信息
- **类型**: SQL Injection
- **CWE**: CWE-89
- **位置**: DatasourceServletAction.java:248
- **严重性**: HIGH
- **CVSS 3.1**: 8.1 (AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:N)

### 权限要求
- ✅ 需要登录认证
- ✅ 任何已认证用户均可访问
- ❌ 无角色限制

### 漏洞描述
`previewData()` 方法直接执行用户提供的 SQL 语句，未进行任何验证或参数化处理。

虽然需要登录，但**任何已认证用户**（包括普通用户）都可以：
- 读取整个数据库的任意表
- 修改/删除数据
- 可能执行系统命令（取决于数据库配置）

### 数据流分析
```java
// Source (用户输入)
String sql = req.getParameter("sql");  // Line 206

// Propagation (无过滤)
// ... (直接传递)

// Sink (危险执行)
jdbc.queryForList(sql, map);  // Line 248
```

### PoC (需要认证)
```http
POST /ureport/datasource?method=previewData HTTP/1.1
Host: vulnerable-app.com
Cookie: SESSION=valid_user_session
Content-Type: application/x-www-form-urlencoded

sql=SELECT password FROM users UNION SELECT table_name FROM information_schema.tables--
```

### 风险评估
- **基础严重性**: Critical (SQL 注入本身)
- **实际严重性**: HIGH (因需要认证而降级)
- **利用难度**: 易 (只需要任意用户账号)
- **影响范围**: 整个数据库
- **业务影响**: 严重数据泄露风险

### 修复建议
**优先级**: P1 (1周内修复)

1. **立即修复** (使用参数化查询):
```java
// 禁止动态 SQL，使用预定义查询
Map<String, String> allowedQueries = Map.of(
    "users", "SELECT id, name FROM users WHERE id = ?",
    "reports", "SELECT * FROM reports WHERE user_id = ?"
);

String queryTemplate = allowedQueries.get(req.getParameter("table"));
jdbc.query(queryTemplate, userId);
```

2. **短期缓解** (添加权限控制):
```java
@PreAuthorize("hasRole('ADMIN')")  // 限制仅管理员
public void previewData(...) {
    // 即使如此，仍需修复注入问题
}
```

3. **长期方案** (移除功能):
- 考虑是否真的需要动态 SQL 预览功能
- 如必需，使用安全的报表工具替代

### 补充说明
虽然此漏洞需要认证，但这**不能**作为忽略它的理由：
- 攻击者可能通过钓鱼/社工获取普通用户账号
- 内部员工可能滥用
- 用户账号可能被暴力破解
- 符合安全合规要求，所有注入漏洞都必须修复
```

### 示例 2: 管理员的命令注入

```markdown
## VULN-015: Command Injection in System Maintenance

### 漏洞信息
- **类型**: Command Injection
- **CWE**: CWE-78
- **位置**: SystemController.java:156
- **严重性**: MEDIUM
- **CVSS 3.1**: 6.5 (AV:N/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H)

### 权限要求
- ✅ 需要登录认证
- ✅ 需要 ADMIN 角色
- ⚠️  仅系统管理员可访问

### 漏洞描述
系统维护接口允许管理员执行清理命令，但未对命令内容进行验证。

虽然仅管理员可访问，但如果管理员账号被攻破（钓鱼、弱密码等），攻击者可以：
- 执行任意系统命令
- 读取敏感文件
- 提权到 root（如果服务以 root 运行）

### PoC (需要管理员权限)
```http
POST /api/admin/system/maintenance HTTP/1.1
Cookie: SESSION=admin_session
Content-Type: application/json

{
  "action": "clean",
  "target": "; cat /etc/passwd #"
}
```

### 风险评估
- **基础严重性**: Critical (命令注入本身)
- **实际严重性**: MEDIUM (因需要高权限而降级)
- **利用难度**: 中 (需要管理员账号)
- **影响范围**: 整个服务器
- **业务影响**: 服务器完全沦陷

### 修复建议
**优先级**: P2 (2-4周内修复)

1. **使用白名单**:
```java
private static final Set<String> ALLOWED_ACTIONS = Set.of(
    "clean_cache",
    "clean_logs",
    "clean_tmp"
);

public void maintenance(String action, String target) {
    if (!ALLOWED_ACTIONS.contains(action)) {
        throw new SecurityException("Invalid action");
    }
    
    // 使用参数数组，不是字符串拼接
    ProcessBuilder pb = new ProcessBuilder(
        "/usr/local/bin/cleanup",
        "--action", action,
        "--target", target
    );
    pb.start();
}
```

2. **移除动态命令执行**:
- 重新设计为预定义的维护任务
- 不接受用户输入作为命令的一部分

### 补充说明
虽然需要管理员权限，但仍然是严重的安全缺陷：
- 管理员账号也可能被攻破
- 内部威胁（恶意管理员）
- 符合最小权限原则，即使管理员也不应能执行任意命令
- 防止账号被盗后的损失扩大
```

---

## 修复优先级矩阵

| 严重性 | 权限等级 | 优先级 | 修复时间 |
|--------|---------|-------|---------|
| Critical | PUBLIC | P0 | 立即 (24h) |
| Critical | AUTH | P0 | 立即 (24h) |
| Critical | PRIV | P1 | 1周 |
| High | PUBLIC | P0 | 立即 (24h) |
| High | AUTH | P1 | 1周 |
| High | PRIV | P2 | 2-4周 |
| Medium | PUBLIC | P1 | 1周 |
| Medium | AUTH | P2 | 2-4周 |
| Medium | PRIV | P3 | 1-2月 |
| Low | ANY | P3 | 1-2月 |

---

## 总结

### ✅ 正确做法

1. **报告所有漏洞**，无论权限等级
2. **根据权限调整风险评级**
3. **在 PoC 中说明权限要求**
4. **提供针对性的修复建议**
5. **区分"不是漏洞"和"低优先级漏洞"**

### ❌ 错误做法

1. ~~因为需要登录就不报告~~
2. ~~认为管理员功能不需要审计~~
3. ~~把权限当作安全控制的唯一手段~~
4. ~~忽略特权用户可能被攻破的风险~~

### 核心理念

> "权限是访问控制，不是漏洞修复。
> 即使有权限门槛，Source → Sink 的不安全数据流仍然是漏洞，
> 只是风险等级和修复优先级有所不同。"

**深度防御原则：**
- 第一层：访问控制（权限）
- 第二层：输入验证
- 第三层：安全的 API 使用
- 第四层：输出编码
- 第五层：监控和日志

即使有了第一层，其他层也不能省略。
